$(function(){
    //var searchType='c';
    var searchTypeText = $("#search-pop .select").find("p").text();
    //alert(searchTypeText);
    var searchType = searchTypeText=="店铺" ? 's' : 'c';
    //  var searchType='';
    //------弹出搜索 start
    var qContent ="";
    addUrl3();
    addUrl($("#search-pop .btn-search"),searchType,qContent);
    $("#search-pop .type-down li a").click(function(){//车辆店铺
        searchType = getSearchType();
        if(qContent==""){
            addUrl($("#search-pop .btn-search"),searchType,"");
        }else{
            addUrl($("#search-pop .btn-search"),searchType,qContent);
        }
    });

    $("#search-pop .input input").keyup(function(){
       //alert("keyup");
        var content = $.trim($(this).val());
        if(content!=null && content != ""){
            $(".moref-down").show();
            qContent = encodeURI(encodeURI(content));   //encodeURIComponent
            //var en = encodeURIComponent(content);
            addUrl($("#search-pop .btn-search"),searchType,qContent);
        }else{
            $(".more-down").hide();
            $("#search-pop .btn-search").attr("href",path+"/search?type="+searchType);
        }
    });
    //-----弹出搜索 end


    //----搜索结果页 start
    if(getQueryString("type")!=null){
        $("#type").empty();
        if(getQueryString("type")=="a" || getQueryString("type")=="c"){
            $("#type").html("车辆");
        }else if(getQueryString("type")=="s"){
            $("#type").html("店铺");
        }
    }

    $("#type-down li a").click(function(){//车辆店铺
        searchType = getSearchType2();
        //alert("选择："+qContent);
        if(qContent==""){
            addUrl($("#search-pop .btn-search"),searchType,"");
        }else{
            addUrl($("#search-pop .btn-search"),searchType,qContent);
        }
    });

    //第二次搜索车辆
    $("#shop_query").keyup(function(){
       // var TypeText = $("#shop_query").text();
        //var cType = TypeText=="店铺" ? 's' : 'c';
        var content = $.trim($(this).val());
        //console.log("======"+content);
        if(content!=null && content != ""){
            qContent = encodeURI(encodeURI(content));   //encodeURIComponent
            //var en = encodeURIComponent(content);
            addUrl($("#btn-search"),searchType,qContent);
        }else{
            $("#btn-search").attr("href",path+"/search?type="+searchType);
        }
    });

    //第二次搜索店铺
    $("#shop_query1").keyup(function(){
        var TypeText = $("#s_type").text();
        var sType = TypeText=="店铺" ? 's' : 'c';
        var content = $.trim($(this).val());
        //console.log("店铺"+TypeText);
        // if(sType == "c") {//表示是车辆查询
        //     if(content!=null && content != ""){
        //         qContent = encodeURI(encodeURI(content));   //encodeURIComponent
        //         //var en = encodeURIComponent(content);
        //         addUrl($("#btn-search"),cType,qContent);
        //
        //     }else{
        //         $("#btn-search").attr("href",path+"/search");
        //     }
        // }else {
            if(content!=null && content != ""){
                qContent = encodeURI(encodeURI(content));//encodeURIComponent
                //var en = encodeURIComponent(content);
                addUrl($("#btn-search"),sType,qContent);
            }else{
                $("#btn-search").attr("href",path+"/search?type="+sType);
            }
        // }
    });
    addUrl2($("#btn_act"),"a", getQueryString("query"));
    addUrl2($("#btn_car"),"c", getQueryString("query"))
    //----搜索结果页 end


    // $("#btn-search").mouseover(function(){
    //  var content = $.trim($("#shop_query").val());
    //  //alert(content)
    //  if(content!=null && content != ""){
    //  $("#btn-search").attr("href",path+"/search?type="+getSearchType2()+"&query="+encodeURI(encodeURI(content)));
    //
    //  }else{
    //  $("#btn-search").attr("href",path+"/search?type="+getSearchType2());
    //  }
    //  });
    //
    // $("#btn-search").mouseover(function(){
    //     var content = $.trim($("#shop_query1").val());
    //     //alert(content)
    //     if(content!=null && content != ""){
    //         $("#btn-search").attr("href",path+"/search?type="+getSearchType2()+"&query="+encodeURI(encodeURI(content)));
    //
    //     }else{
    //         $("#btn-search").attr("href",path+"/search?type="+getSearchType2());
    //     }
    // });


    //图片路径
    $("#searchCar .image img").each(function(){
        var imgsrc=$(this).attr("src");
        imgsrc=imgchang(imgsrc,"280x210");
        $(this).attr("src",imgsrc);
    });
});
//加切图尺寸
function imgchang(src,size){
    var index=src.lastIndexOf(".");
    if(index>0){
        var imgtype=src.substring(index);
        src=src.replace(imgtype,"_"+size+imgtype);
    }
    return src;
}
//获取搜索的范围
function getSearchType(){
    var txt = $("#search-pop .select").find("p").text();
    return txt=="车辆" ? 'c' : 's';
}
function getSearchType2(){
    var txt = $("#c_type").text();
    return txt=="车辆" ? 'c' : 's';
}


//我要买车页面   第一次搜索获取的值
function addUrl(obj,type,query){
    //alert("addUrl"+query)
    if(query=="" || query==null){
        obj.attr("href",path+"/search?type="+type);
    }else{
        obj.attr("href",path+"/search?type="+type+"&query="+query);
    }
}

//我要买车页面  第二次搜索获取的值
function addUrl2(obj,type,query){
    if(query=="" || query==null){
        obj.attr("href",path+"/search?type="+type);
    }else{
        obj.attr("href",path+"/search?type="+type+"&query="+encodeURI(query));
    }
}

function getQueryString(name) {
    //这个方法是获得页面url的某个url参数的方法   类似浏览器地址栏地址参数部分格式的正则匹配

    // 这个正则是寻找&+url参数名字=值+&    &可以不存在。
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"); // 匹配这样的类似参数,但是他只取name参数部分
    //var r = window.location.search.substr(1).match(reg);
    // console.log("qryStr"+qryStr);
    // console.log("decode qryStr:::"+decodeURI(qryStr));
    var qryStr = window.location.search.substr(1);
    var r = qryStr.match(reg);
    if (r != null){
        // console.log("r[2]"+r[2]);
        // console.log("unescape(r[2])"+decodeURIComponent(r[2]));
        return decodeURIComponent(r[2]);
    }else{
        return null;  //这里是开始匹配，找到了返回对应url值，没找到返回null。
    }
}


//页面加载时出现
function addUrl3(){
    $(".pageBox a").each(function(index,value){
        if($(this).attr("href") != undefined) { //添加空对象的判断，规避JS报错
            if ($(this).attr("href").indexOf("query=") > 1) {
                var url = encodeURI($(this).attr("href"));
                var u = url.substring(url.indexOf("/search") + 1);
                $(this).attr("href", encodeURI(u));
            }
        }
    });
}

