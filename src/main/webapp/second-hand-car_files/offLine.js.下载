var offLineCount = 0;
$(function(){
	if($.cookie('loginPage') != window.location.href){
		getOffLineNum();
	}else{
		setInterval(getOffLineNum,1000);
	}
});
$(function(){
	$("#btn-online").click(function(){
		$("#btn-online").attr("class","new-msg-e");
		$("#btn-online").attr("style","display: block;");
		step = 4;
		document.title = '奥迪';
		fromPageName = "奥迪在线4S店主页";
		fromPageUrl = window.location.href;
		ipRegion = "";
		ipnum = "";
		carTypeName = "";
		carTypeId = "";
		takeTo = "admin";
		alertText = "当前用户点通过击查看未读消息发起对话申请";
		onLineTake();
	});
});
//function getOffLineNum(){
//	
//	//判断当前页是否是登录页
//	var f = false;
//	if($.cookie('loginPage') == window.location.href){
//		f = true;
//	}
//	$.ajax({//获取用户在线状态
//		url:"getUserType",
//		success:function(res){
////			$("#testJs").val("res:"+res);
////			alert(res);
//			if(res != "\"false\""){
//				if(res == "\"Unavailable\""){
//					//用户未登录IM
//					if(cheilSource == "pc"){
//						$("#btn-online").attr("class","new-msg-e");
//						$("#btn-online").attr("style","display: block;");
//					}else{
//						$(".nav sup").attr("style","display: none;");
//						$(".nav sup").html("");
//					}
//					if(f){
//						$.ajax({
//							url:"ofOffLineCount",
//							success:function(res){
//								var json = JSON.parse(res);
//								if(cheilSource == "pc"){
//									if(json.msg > offLineCount){
//										flash_title();
//									}
//									if(json.msg == 0){
//										$("#offLineNum").html("在线咨询");
//									}else{
//										$("#offLineNum").html("在线咨询（"+json.msg+"）");
//									}
//									offLineCount = json.msg;
//								}else{
//									if(json.msg == 0){
//										json.msg = "";
//										$(".nav sup").attr("style","display: none;");
//									}else{
//										$(".nav sup").attr("style","display: inline-table;");
//									}
//									$("#btn-online").attr("style","display: none;");
//									$(".nav sup").html(json.msg);
//								}
//							}
//						});
//					}
//				}else{
//					//用户已登录IM
//					var cookie = $.cookie('imOffLineNum');
//					if(cookie == null || cookie == "NaN"){
//						cookie = 0;
//					}
//					if(cheilSource == "pc"){
//						$("#btn-online").attr("class","new-msg");
//						$("#btn-online").attr("style","display: block;");
////						alert(offLineCount);
//						if(cookie > 0){
////						if(cookie > offLineCount){
//							flash_title();
//						}
//						if(cookie == 0){
//							$("#offLineNum").html("在线咨询");
//						}else{
//							$("#offLineNum").html("在线咨询（"+cookie+"）");
//						}
//						offLineCount = cookie;
//					}else{
//						$("#btn-online").attr("style","display: none;");
//						if(cookie == 0){
//							cookie = "";
//							$(".nav sup").attr("style","display: none;");
//						}else{
//							$(".nav sup").attr("style","display: inline-table;");
//						}
//						$(".nav sup").html(cookie);
//					}
//				}
//			}
//		}
//	});
//}
/*function getOffLineNum(){
	//判断当前页是否是登录页
	var f = false;
	if($.cookie('loginPage') == window.location.href){
		f = true;
	}
	//修改登录页的标签提醒
	if(f){
		if($.cookie('ofLinfType') == 1){
			$.cookie("ofLinfType",0,{expires:365});
			flash_title();
		}
	}
	//获取cookie
	var cookie = $.cookie('imOffLineNum'); 
	$("#testJs").val("cookie:"+cookie);
	if(cookie == null || cookie == "NaN"){
		$("#btn-online").attr("style","display: none;");
		return false;
	}else{
		//判断当前用户IM是否登录
		if(cookie == "-100"){//没有登录IM
			var offLineCount = 0;
			//判断当前设备是否是pc
			if(cheilSource == "pc"){
				if(f){
					$.ajax({
						url:"ofOffLineCount",
						success:function(res){
							var json = JSON.parse(res);
							if(json.msg > offLineCount){
								flash_title();
							}
							
							if(json.msg == 0){
								$("#offLineNum").html("在线咨询");
							}else{
								$("#offLineNum").html("在线咨询（"+json.msg+"）");
							}
							offLineCount = json.msg;
						}
					});
				}
				$("#btn-online").attr("class","new-msg-e");
				$("#btn-online").attr("style","display: block;");
				
			}else{
				//手机端的显示样式
				
			}
		}else{//当前用户已登录IM
//				if(f){
			$.ajax({//获取用户在线状态
				url:"getUserType",
				success:function(res){
					$("#testJs").val("res:"+res);
					if(res == "\"Unavailable\""){
						$.cookie("imOffLineNum","-100",{expires:365});
					}else{
						
					}
				}
			});
//				}
			
			
			if(cheilSource == "pc"){//pc端的显示样式
				$("#btn-online").attr("class","new-msg");
				$("#btn-online").attr("style","display: block;");
				if(cookie == 0){
					$("#offLineNum").html("在线咨询");
				}else{
					$("#offLineNum").html("在线咨询（"+cookie+"）");
				}
			}else{//手机端的显示样式
				
				
				
			}
		}
	}
}
*/
function getOffLineNum(){

//	获取cookie中的值
	var cookie = $.cookie('imOffLineNum');
//	alert("cookie="+cookie);
	if(cookie == null || cookie == "NaN"){
//		cookie = 0;
	}else{
//		判断当前页是否是登录页
//		var f = false;
//		alert("cookie:"+$.cookie('loginPage'));
//		if($.cookie('loginPage') != window.location.href){
////			f = true;
//			$("#btn-online").attr("class","new-msg-e");
//			$("#btn-online").attr("style","display: block;");
//			return false;
//		}
		$.ajax({
			url:path+"/getUserType",
			success:function(res){
//				alert(res);
				if(res != "\"false\""){
					if(res == "\"Unavailable\""){//IM未登录
						$.ajax({
							url:path+"/ofOffLineCount",
							success:function(res){
								var json = JSON.parse(res);
								if(cheilSource == "pc"){//当前为pc页面
//									alert(json.msg);
									if(json.msg > offLineCount){
										flash_title();//页面标签闪动提示
									}
									if(json.msg == 0){//无消息时提示框为灰色
										$("#offLineNum").html("在线咨询");
										$("#btn-online").attr("class","new-msg-e");
										$("#btn-online").attr("style","display: block;");
										document.title = '奥迪';
									}else{//有消息时提示框为红色
										$("#offLineNum").html("在线咨询（"+json.msg+"）");
										$("#btn-online").attr("class","new-msg");
										$("#btn-online").attr("style","display: block;");
									}
									offLineCount = json.msg;
								}else{//当前为phone页面
									if(json.msg == 0){
										$(".nav sup").attr("style","display: none;");
										//$(".audi-place span").each(function(index,value){
											
										//	if($(this).parent().attr("id")!="area"){
												$(".audi-place span").attr("class","mobile-menu");
												$(".audi-place #area span").attr("class","icon-down");
										//	}
											
										//});
										
										$(".news span").html(json.msg);
										json.msg = "";
									}else{
										if(json.msg>9){
											$(".news span").html("");
										}else{
											$(".news span").html(json.msg);
										}
										$(".nav sup").attr("style","display: inline-table;");
                                        //$(".audi-place span").each(function(index,value){
											
										//	if($(this).parent().attr("id")!="area"){
												$(".audi-place span").attr("class","mobile-menu on");
												$(".audi-place #area span").attr("class","icon-down");
										//	}
											
										//});
										
									}
									$("#btn-online").attr("style","display: none;");
									$(".nav sup").html(json.msg);
									
								}
							}
						});
					}else{//IM已登录
						
						if(cheilSource == "pc"){//当前为pc页面
//							if(cookie > 0){
							if(cookie > offLineCount){
								flash_title();
							}
//							alert(cookie);
							if(cookie == 0){
								$("#offLineNum").html("在线咨询");
								$("#btn-online").attr("class","new-msg-e");
								document.title = '奥迪';
							}else{
								$("#offLineNum").html("在线咨询（"+cookie+"）");
								$("#btn-online").attr("class","new-msg");
							}
							$("#btn-online").attr("style","display: block;");
							offLineCount = cookie;
						}else{//当前为phone页面
							$("#btn-online").attr("style","display: none;");
							if(cookie == 0){
								$(".nav sup").attr("style","display: none;");
								 //$(".audi-place span").each(function(index,value){
										
								//		if($(this).parent().attr("id")!="area"){
											$(".audi-place span").attr("class","mobile-menu");
											$(".audi-place #area span").attr("class","icon-down");
								//		}
										
								//	});
								
								$(".news span").html(cookie);
								cookie = "";
							}else{
								if(cookie>9){
									$(".news span").html("");
								}else{
									$(".news span").html(cookie);
								}
								$(".nav sup").attr("style","display: inline-table;");
								$(".nav sup").attr("style","display: inline-table;");
							}
							$(".nav sup").html(cookie);
							
						}
					}
				}else{
					//没登陆网站
//					$("#offLineNum").html("在线咨询");
//					$("#btn-online").attr("class","new-msg-e");
//					$("#btn-online").attr("style","display: block;");
				}
			}
		});
	}
}
